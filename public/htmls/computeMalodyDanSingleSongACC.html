<!DOCTYPE html>
<!-- saved from url=(0064)https://other.ecuder.cn/htmls/computeMalodyDanSingleSongACC.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>计算段位单曲ACC</title>
<style type="text/css">#_copy{align-items:center;background:#4494d5;border-radius:3px;color:#fff;cursor:pointer;display:flex;font-size:13px;height:30px;justify-content:center;position:absolute;width:60px;z-index:1000}#select-tooltip,#sfModal,.modal-backdrop,div[id^=reader-helper]{display:none!important}.modal-open{overflow:auto!important}._sf_adjust_body{padding-right:0!important}.super_copy_btns_div{position:fixed;width:154px;left:10px;top:45%;background:#e7f1ff;border:2px solid #4595d5;font-weight:600;border-radius:2px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Helvetica Neue,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;z-index:5000}.super_copy_btns_logo{width:100%;background:#4595d5;text-align:center;font-size:12px;color:#e7f1ff;line-height:30px;height:30px}.super_copy_btns_btn{display:block;width:128px;height:28px;background:#7f5711;border-radius:4px;color:#fff;font-size:12px;border:0;outline:0;margin:8px auto;font-weight:700;cursor:pointer;opacity:.9}.super_copy_btns_btn:hover{opacity:.8}.super_copy_btns_btn:active{opacity:1}</style></head>

<body _c_t_common="1" class="vsc-initialized" _c_t_j1="1">
    <div>计算段内每首曲子ACC (Malody .mc文件)</div>
    <input type="file">
    <div class="song-name"></div>
    <div class="text"></div>
    <script>
        // 获取malody段位各个曲子的键数
        const $input = document.querySelector("input");
        const $songName = document.querySelector(".song-name");
        const $text = document.querySelector(".text");

        import("https://cdn.jsdelivr.net/npm/unstable/src/module/readFile.js")
            .then(r => globalThis.readFileAsText = r.readFileAsText);

        function getMalodySongsKeys(data, timeInterval = 15) {
            let songStartPosition = data.note.reduce((res, v, i) => {
                if (i === 0) {
                    return res;
                }
                let pre = data.note[i - 1];
                v.beat[0] - pre.beat[0] >= timeInterval && res.push(i);
                return res;
            }, [0]);
            let songsKeys = songStartPosition.map((v, i, a) => {
                if (i < a.length - 1) {
                    return a[i + 1] - v;
                } else {
                    return data.note.length - v;
                }
            });
            return songsKeys;
        }
        $input.onchange = () => {
            const f = $input.files[0];
            readFileAsText(f)
                .then(r => {
                    let data = JSON.parse(r);
                    let songsKeys = getMalodySongsKeys(data);
                    console.log(data);
                    let input = prompt(`
                    ${data.meta.version}
                    请输入每首曲子结束后的ACC，使用/分隔`);
                    let ACCs = input.split(/\//).map(v => Number(v));
                    let singleSongACCs = ACCs.map((acc, i, arr) => {
                        
                        // 示例输入： 96.34/95.2/95.78/96.09
                        // 其实是作者的EX5 ACC

                        // 上一首结束的有效key数
                        let preSongsValidKeys;
                        if(i === 0) {
                            preSongsValidKeys = 0;
                        }else {
                            preSongsValidKeys = songsKeys.slice(0, i).reduce((p, v) => p + v, 0) * (arr[i - 1] / 100);
                        }

                        // 这首结束的有效key数
                        let songsValidKeys;
                        if(i === arr.length - 1) {
                            songsValidKeys = data.note.length * (acc / 100); 
                        }else {
                            // slice截取到目标之前，故+1
                            songsValidKeys = songsKeys.slice(0, i + 1).reduce((p, v) => p + v, 0) * (acc / 100);
                        }

                        // 有效键数
                        let validKeys = songsValidKeys - preSongsValidKeys;

                        // 单曲acc
                        let singleSongACC = (validKeys / songsKeys[i]);

                        return singleSongACC;
                    });

                    let showACCs = singleSongACCs.map(v=> Number((v * 100).toFixed(2))); // 取二位小数

                    $songName.textContent = data.meta.version;
                    $text.innerHTML = `
                    <div>您的ACC变化: ${input.split("/").join(" / ")}</div>
                    <div>您的每首曲子ACC分别为: ${showACCs.join(" / ")}</div>
                    <div>每首曲子物量：${songsKeys.join(" / ")}</div>
                    `;
                })
                .catch(console.log);
        };

        // Ex5
        [3230, 2732, 2562, 2110];
    </script>


</body></html>